<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Re:Anime ¬∑ Ver episodio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fuentes optimizadas -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Tokyo+Zoo&display=swap" rel="stylesheet">

  <style>
:root{
      --pink:#ff4ecd;
      --pink-soft:#ffb6d9;
      --bg:#0f0f14;
      --panel:#181820;
      --text:#f1f1f1;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui, sans-serif;
      background:linear-gradient(135deg,#ffe1f0,#caf0f8);
      color:#222;
      transition: background 1s ease, color 0.5s;
    }
    body.dark{
      background:linear-gradient(135deg,#0f0f14,#1b1b2a);
      color:var(--text);
    }

    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:1rem 1.5rem;
      background:#fff0fa;
      border-bottom:1px solid #ddd;
      transition: background 0.5s, color 0.5s;
    }
    body.dark header{
      background:#1e1e1e;
      border-bottom:1px solid #222;
    }
    header h1{
      font-family:'Zen Tokyo Zoo', cursive;
      color:#ff4ecd;
      font-size:1.8rem;
      margin:0;
    }
    .theme-toggle {
      position: relative;
      background: #ff8fab;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 30px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 0 10px #ff8fab80;
      transition: 0.3s;
    }
    .theme-toggle:hover { background-color: #ff4ecd; }
    #login-btn{
      background:#ff8fab;
      color:#fff;
      border:none;
      padding:.5rem 1.2rem;
      border-radius:20px;
      font-weight:bold;
      text-decoration:none;
      box-shadow: 0 0 10px #ff8fab80;
      transition: 0.3s;
    }
    #login-btn:hover { background-color: #ff4ecd; }
    #user-info {
      position: fixed; top: 10px; right: 10px;
      display: flex; align-items: center; gap: 0.5rem;
      z-index: 1001; cursor: pointer;
    }
    #user-info img { width: 40px; border-radius: 50%; }
    #user-popup {
      position: fixed; top: 60px; right: 10px;
      background: #fff0fa; color: #333;
      border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 1rem; min-width: 200px; z-index: 1002;
      display: none; text-align: left;
    }
    #user-popup button {
      margin-top: 1rem; background: #ff4ecd;
      color: white; padding: 0.5rem 1rem;
      border: none; border-radius: 20px;
      cursor: pointer; width: 100%;
    }

    .container{
      max-width:1200px;
      margin:auto;
      padding:1.2rem;
    }

    .top{
      display:flex;
      gap:1rem;
      align-items:center;
    }
    .cover{
      width:110px;
      height:155px;
      object-fit:cover;
      border-radius:12px;
    }
    .anime-title{
      font-size:1.6rem;
      font-weight:bold;
      color:var(--pink-soft);
    }
    .genres span{
      display:inline-block;
      margin:.3rem .3rem 0 0;
      padding:.25rem .7rem;
      border-radius:20px;
      background:#ff8fab88;
      font-size:.8rem;
      color:#333;
      transition: background 0.3s;
    }
    body.dark .genres span{
      background:#2a2a3a;
      color:#fff;
    }

    .layout{
      display:grid;
      grid-template-columns:240px 1fr;
      gap:1.2rem;
      margin-top:1.5rem;
    }

    .episodes{
      background:#fff0fa;
      border-radius:14px;
      padding:.8rem;
      max-height:70vh;
      overflow:auto;
      transition: background 0.5s;
    }
    body.dark .episodes{
      background:var(--panel);
    }
    .episodes button{
      width:100%;
      margin-bottom:.4rem;
      background:#2a2a3a;
      border:none;
      border-radius:10px;
      padding:.6rem;
      color:#fff;
      text-align:left;
      cursor:pointer;
    }
    .episodes button.active{background:#ff4ecd}

    .player{
      background:var(--panel);
      border-radius:16px;
      padding:1rem;
    }
    .player h3{margin:.2rem 0 1rem;color:var(--pink-soft)}

    .video-wrapper{
      position:relative;
      width:100%;
      aspect-ratio:16/9;
      background:#000;
      border-radius:14px;
      overflow:hidden;
    }
    iframe{width:100%;height:100%;border:none}

    /* Ram Light */
    #ram-light{
      position:fixed;
      bottom:20px;
      right:20px;
      width:64px;
      height:64px;
      z-index:50;
      cursor:pointer;
    }
    #ram-bubble{
      position:absolute;
      bottom:75px;
      right:0;
      background:#fff0fa;
      color:#ff4ecd;
      border-radius:14px;
      padding:.6rem .9rem;
      font-size:.85rem;
      max-width:240px;
      display:none;
    }
    #ram-actions button{
      background:#ff4ecd;
      color:#fff;
      border:none;
      border-radius:10px;
      padding:.35rem;
      font-size:.75rem;
      cursor:pointer;
    }

    @media(max-width:900px){
      .layout{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

<header>
  <h1>Re:Anime</h1>
  <div style="display:flex; align-items:center; gap:1rem;">
    <button class="theme-toggle" onclick="toggleTheme()" id="theme-toggle">üåó Tema</button>
    <a id="login-btn" href="#">Iniciar sesi√≥n con Discord</a>
  </div>
</header>

<div class="container" id="app">Cargando‚Ä¶</div>

<div id="user-info" class="hidden"></div>
<div id="user-popup"></div>

<!-- Ram Light -->
<div id="ram-light">
  <img id="ram-img" src="Assets/ReAnime-Mascot.png" alt="Ram" width="64" height="64" loading="lazy">
  <div id="ram-bubble">
    <div id="ram-text">¬øEn qu√© puedo ayudarte?</div>
    <div id="ram-actions" style="margin-top:.5rem;display:grid;grid-template-columns:1fr 1fr;gap:.4rem;">
      <button data-act="watch">Ver juntos</button>
      <button data-act="opinion">Opini√≥n</button>
      <button data-act="fact">Dato</button>
      <button data-act="rating">Rating</button>
      <button data-act="similar" style="grid-column:1/3">üîÅ Similar</button>
    </div>
  </div>
</div>
</div>

<script>
const $=q=>document.querySelector(q);
const $$=q=>document.querySelectorAll(q);

const ram = $('#ram-light');
const ramBubble = $('#ram-bubble');
const ramText = $('#ram-text');
const ramActions = $('#ram-actions');

ram.onclick = (e)=>{
  e.stopPropagation();
  ramBubble.style.display = ramBubble.style.display==='block'?'none':'block';
};

document.addEventListener('click',()=>ramBubble.style.display='none');

const params = new URLSearchParams(location.search);
const animeId = params.get('id');

fetch('animes.json').then(r=>r.json()).then(data=>{
  const anime = data.find(a=>a.id===animeId);
  if(!anime){ $('#app').textContent='Anime no encontrado'; return; }

  window.currentAnime = anime;
  document.title = anime.name+' ¬∑ Re:Anime';

  $('#app').innerHTML = `
    <div class="top">
      <img class="cover" src="${anime.cover}" loading="lazy">
      <div>
        <div class="anime-title">${anime.name}</div>
        <div class="genres">${anime.genre.map(g=>`<span>${g}</span>`).join('')}</div>
      </div>
    </div>

    <div class="layout">
      <div class="episodes" id="epList"></div>
      <div class="player">
        <h3 id="epTitle">Selecciona un episodio</h3>
        <div class="video-wrapper" id="video"></div>
        <a href="cine.html?id=${anime.id}" style="display:inline-block;margin-top:.8rem;color:#ff4ecd;font-weight:bold">üé¨ Ver anime con Ram (modo cine)</a>
      </div>
    </div>
  `;

  const epList=$('#epList');
  const video=$('#video');
  const epTitle=$('#epTitle');

  anime.episodes.forEach((ep,i)=>{
    const btn=document.createElement('button');
    btn.textContent=`Ep ${ep.number}: ${ep.title}`;
    btn.onclick=()=>{
      $$('.episodes button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      epTitle.textContent=`Ep ${ep.number}: ${ep.title}`;
      const tmp=document.createElement('div');
      tmp.innerHTML=ep.embed;
      const iframe=tmp.querySelector('iframe');
      iframe.loading='lazy';
      video.innerHTML='';
      video.appendChild(iframe);
      localStorage.setItem('lastWatched',JSON.stringify({id:anime.id,index:i}));
    };
    epList.appendChild(btn);
  });

  const last=JSON.parse(localStorage.getItem('lastWatched')||'null');
  if(last&&last.id===anime.id&&epList.children[last.index]){
    epList.children[last.index].click();
  }else{
    epList.children[0]?.click();
  }
});

// Ram actions
ramActions?.addEventListener('click',e=>{
  e.stopPropagation();
  if(!e.target.dataset.act||!window.currentAnime) return;
  const a = window.currentAnime;
  const r = k => a[k] && a[k].length ? a[k][Math.floor(Math.random()*a[k].length)] : 'No tengo datos ahora.';
  const act = e.target.dataset.act;
  let response = '';
  if(act==='watch') location.href = `cine.html?id=${a.id}`;
  else {
    if(act==='opinion') response = r('opinion');
    if(act==='fact') response = r('dato');
    if(act==='rating') response = `${a.name} tiene ${a.rating}/10`;
    if(act==='similar'){
      fetch('animes.json').then(r=>r.json()).then(list=>{
        const sim=list.filter(x=>x.id!==a.id && x.genre.some(g=>a.genre.includes(g)));
        response = sim.length?`Te recomiendo ${sim[Math.floor(Math.random()*sim.length)].name}`:'No encontr√© uno parecido.';
        showRamResponse(response);
      });
      return;
    }
    showRamResponse(response);
  }
});

function showRamResponse(text) {
  ramText.innerHTML = text;
  ramBubble.style.display = 'block';
  ramActions.style.display = 'none';
  setTimeout(() => {
    ramBubble.style.display = 'none';
    ramActions.style.display = 'grid';
  }, 7000);
}

const clientId = "1390810180823945350";
const redirectUri = "https://imram-software.github.io/ReAnime/callback.html";
const scope = "identify";
const loginBtn = document.getElementById("login-btn");
loginBtn.href = `https://discord.com/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${scope}`;

const user = JSON.parse(localStorage.getItem("user"));
const userInfo = document.getElementById("user-info");
const userPopup = document.getElementById("user-popup");

if (user) {
  loginBtn.style.display = "none";
  const avatarUrl = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
  userInfo.classList.remove("hidden");
  userInfo.innerHTML = `<img src="${avatarUrl}" /><span>${user.username}</span>`;
  userInfo.onclick = () => {
    userPopup.style.display = userPopup.style.display === "block" ? "none" : "block";
    userPopup.innerHTML = `
      <strong>${user.username}#${user.discriminator}</strong><br>
      <img src="${avatarUrl}" width="80" style="border-radius:50%; margin-top:0.5rem;"><br>
      <button onclick="window.location.href='profile.html'">Perfil</button><br>
      <button onclick="logout()">Cerrar sesi√≥n</button>
    `;
  };
}

function logout() {
  localStorage.removeItem("user");
  localStorage.removeItem("user_data");
  location.reload();
}

const theme = localStorage.getItem("theme") || "light";
document.body.classList.add(theme);

function toggleTheme() {
  const current = localStorage.getItem("theme") || "light";
  const next = current === "light" ? "dark" : "light";
  document.body.classList.replace(current, next);
  localStorage.setItem("theme", next);
}
</script>

<!-- Comentarios (optimizado) -->
<div style="max-width:1200px;margin:2rem auto;padding:1rem;border-top:1px solid #222">
  <script src="https://utteranc.es/client.js"
    repo="imram-software/ReAnime"
    issue-term="url"
    theme="preferred-color-scheme"
    crossorigin="anonymous"
    async></script>
</div>

</body>
</html>
